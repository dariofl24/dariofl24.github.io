*** Settings ***
Documentation     General Site Declarations and main functions
Library           Selenium2Library
Resource          environment_variables.txt
Resource          common.txt
Resource          common_keywords.txt

*** Variables ***
${L_FIRSTPRODUCT}    //ul[@id=('search-result-items')]/li[1]//div[@class='product-image']//a
${D_MINICART}     //div[@id='mini-cart']
#${D_MINICART}    //div[@id='wrapper']/div[@id='header']//a[@class='mini-cart-link']/div[@id='mini-cart']/span
#[a] is just provisional until cart duplication is removed from the header
${L_CONVERSE}     //header/div[@class='desktop-only']/div[@class='primary-logo']/a
${D_CATEGORYCONTAINER}    /nav/div[3]
${D_MENCATEGORY}    /ul/li[1]/a
${L_MENSUBCATDISPLAYED}    //div[@class='external-category-container expanded']
${L_MENSUBCATHIDDEN}    //div[@class='external-category-container']
${L_NOSUBCATEGORYCATEGORY}    //a[@class='level-1'][@data-category='
${L_SPECIFIC_CATEGORY}    //*[@id='
${D_SPECIFIC_SUBCATEGORY}    //*[@id="navigation"]/nav/div[4]/div[1]/div/div/ul[1]/li[
${D_SEARCHBUTTONLBL}    //div[@id='search-button']
${D_HEADER}       //div[@id='header']
${D_SEARCHHEADER}    //div[@id='search-bar']
${D_NAVIGATION}    //*[@id="navigation"]
${B_SEARCHCLOSE}    //button[@class='action-close hide-text']
${I_SEARCHTEXT}    //input[@id='q']
#${I_SEARCHTEXT}    //div[1]//input[@placeholder='Search Keyword']
${B_LOGIN}        //div[@id='menu-utility-user']//div[@id='account-info-box']
#${L_PRODUCT}     //div[@class='product-image']//a[contains(@href, '
${D_PRODUCTTILE}    //div[@class=('product-tile')]
${D_HOMEPAGESLIDER}    //div[@id='main']//div//div[@id='homepage-slider']
${C_SLIDERPREVIOUS}    //a[@class='slider-prev']
${D_SLIDESNUMBER}    //div[@id='slides']//div[@class='slides_container']//div//
${D_LOGINCONTAINER}    //div[@data-slider-area='login-panel']
${B_CREATEACCOUNT}    //div[@id='login-or-register-container']//div[@id='create-account-container']//div[@class='div-table-cell']//div[@class='form-row form-row-button']//div[@id='create-account-btn']
${D_REGCONTAINER}    //div[@id='login-or-register-container']//div[@class='form-meta-data']
${F_REGISTEREXPANDED}    [@style='display: block;']
${F_REGISTERCOLLAPSED}    [@style='display:none;']
${B_SEARCHSUBMIT}    //button[@type='submit']
#${B_SEARCHSUBMIT}    //div[@id='navigation']/nav/div[1]/form/div/span[1]/button
${H_PRIMARYLOGO}    //div[@class='primary-logo']//span
${H_SLOT}         hero-slot
${L_FOOTER}       //div[@id='footer-links']
#SEARCH LOCATORS
${NO_RESULTS_MESSAGE}    //div[@class='noresults-section noresults-section-1 primary-focus clearfix']//span[@class='noresults-heading'][contains (text(),'
${RESULTS_MESSAGE}    //h1[@id='results-products']/span[contains (text(),'
#CATEGORY RESULTS PAGE LOCATORS
${L_ALLSEARCH_RESULTS}    //div[@id='main-overlay']//div[@id='main']//li[@class='grid-tile']
${U_ALLCAT_TABS}    //ul[contains(@class,'ui-tabs-nav')]//li
${D_GRID_TILES}    //ul[@id='search-result-items']/li[@class='grid-tile']
#//div[contains(@class,'search-result-content')]//li[@class='grid-tile']
${A_MORERESULTS}    //div[@class='cta-button']/a
${D_CATEGORYLP}    //div[@id='b-s-container-
${LIGHTBOX}       //div[@class='close-button']    # //div[@class='close-button']

*** Keywords ***
Open Browser to Converse Site
    ${siteURL} =    Set URL Credentials
    Open Browser    ${siteURL}    ${browser}
    Set Selenium Timeout    ${sel_timeout}
    Wait Until Page Contains Element    footer
    Maximize Browser Window
    Set Selenium Speed    ${sel_speed}
    #Click Element    //div [@class='close-button']
    Close Email Dialog If Present

Set URL Credentials
    ${UrlSet} =    Catenate    https://@{USER}[${env_id}]:@{PASSWORD}[${env_id}]@@{LIST_ENVIRONMENT}[${env_id}].demandware.net@{ENV_SUFFIX}[${env_id}]
    ${UrlNotSet} =    Catenate    https://@{LIST_ENVIRONMENT}[${env_id}].demandware.net@{ENV_SUFFIX}[${env_id}]
    ${SiteURL} =    Set Variable If    @{SEND_CREDENTIALS}[${env_id}]==0    ${UrlSet}    ${UrlNotSet}
    ${SiteURL} =    Set Variable If    ${env_id} == 1    ${productionURL}    ${SiteURL}
    [Return]    ${SiteURL}

Set Feed Credentials
    [Arguments]    ${feedURL}
    ${UrlNotSet} =    Catenate    http://@{LIST_ENVIRONMENT}[${env_id}]${feedURL}
    [Return]    ${UrlNotSet}

Open ECN
    Run Keyword If    '@{ENV_TYPE}[${env_id}]' == "test"    Go-to ECN

Go-To ECN
    ${ecnURL}=    Catenate    http://@{CUS_CREDENTIALS_TEST}[1]:@{CUS_CREDENTIALS_TEST}[2]@@{CUS_CREDENTIALS_TEST}[0]/builder/utils/conversenav.html
    Go To    ${ecnURL}
    Sleep    5

Search Specific Product
    [Arguments]    ${productId}
    #Click Element    ${D_HEADER}${D_SEARCHBUTTONLBL}
    #Wait Until Page Contains Element    ${D_NAVIGATION}${D_SEARCHHEADER}[@style='display: block;']
    Input Text    ${I_SEARCHTEXT}    ${productId}
    Wait Until Page Contains Element    ${B_SEARCHSUBMIT}
    Click Element    ${B_SEARCHSUBMIT}

Open Cart
    Wait Until Page Contains Element    ${D_MINICART}
    Click Element    ${D_MINICART}
    Wait Until Page Contains    Cart

Verify Empty Cart Link Opens Cart Show Page and Empty Cart Message is Displayed
    Wait Until Page Contains    Your Cart is Empty
    #Location Should Contain    Cart-Show

Return HomePage
    Wait Until Page Contains Element    ${L_CONVERSE}
    Click Element    ${L_CONVERSE}

Expand and Collapse Categories is Displaying and Hiding Categories Container
    Page Should Contain Element    ${D_NAVIGATION}${D_CATEGORYCONTAINER}
    Click Element    ${D_NAVIGATION}${D_CATEGORYCONTAINER}${D_MENCATEGORY}
    #${value} =    Get Attribute Value    ${L_MENSUBCATDISPLAYED}    class
    #Should Be Equal    ${value}    level-2 \ active
    Wait Until Page Contains Element    ${L_MENSUBCATDISPLAYED}
    Click Element    ${D_NAVIGATION}${D_CATEGORYCONTAINER}${D_MENCATEGORY}
    Wait Until Page Contains Element    ${L_MENSUBCATHIDDEN}

Verify Empty Category is Redirecting to Search Page for the Same Category
    Click Element    ${D_NAVIGATION}${D_CATEGORYCONTAINER}${L_NOSUBCATEGORYCATEGORY}@{EMPTY_CATEGORY}[2]']
    Location Should Contain    Search-Show?cgid=@{EMPTY_CATEGORY}[2]
    Return Homepage

Opens Search Container
    Click Element    ${D_HEADER}${D_SEARCHBUTTONLBL}
    Wait Until Page Contains Element    ${D_NAVIGATION}${D_SEARCHHEADER}[@style='display: block;']
    Page Should Contain Textfield    ${I_SEARCHTEXT}

Verify Search Functionality Available in Header
    Opens Search Container
    Click Element    ${D_NAVIGATION}${B_SEARCHCLOSE}

Verify Search Header Can be Collapsed
    Click Element    ${D_HEADER}${D_SEARCHBUTTONLBL}
    Wait Until Page Contains Element    ${D_NAVIGATION}${D_SEARCHHEADER}[@style='display: block;']
    Click Element    ${D_NAVIGATION}${B_SEARCHCLOSE}
    Wait Until Page Contains Element    ${D_NAVIGATION}${D_SEARCHHEADER}[@style='display: none;']

Verifies Slider Contais More Than One Image
    Page Should Contain Element    ${D_HOMEPAGESLIDER}
    ${slideNumber}    Get Matching Xpath Count    ${D_HOMEPAGESLIDER}${D_SLIDESNUMBER}

Click Login
    Wait Until Page Contains Element    ${D_HEADER}${B_LOGIN}
    Click Element    ${D_HEADER}${B_LOGIN}

Verify Login Form is Expanded
    ${value} =    Get Attribute Value    ${D_LOGINCONTAINER}    style
    Should Contain    ${value}    display: block;
    #Wait Until Page Contains Element    ${D_LOGINCONTAINER}[@style="display: block;"]

Verify Login Form is Collapsed
    Sleep    1
    ${value} =    Get Attribute Value    ${D_LOGINCONTAINER}    style
    Should Contain    ${value}    display: none;

Click Register
    Wait Until Page Contains Element    ${B_CREATEACCOUNT}
    Click Element    ${B_CREATEACCOUNT}

Verify Register Form is Expanded
    Wait Until Page Contains Element    ${D_REGCONTAINER}${F_REGISTEREXPANDED}

Verify Register Form is Collapsed
    Wait Until Page Contains Element    ${D_REGCONTAINER}${F_REGISTERCOLLAPSED}

Set Environment URL
    [Return]    ${UrlSet}

Verify Hero Slot
    Wait Until Page Contains Element    ${H_SLOT}

Search verification
    [Arguments]    ${searched_term_found}    ${searched_term_not_found}    ${message_found}    ${messageNotFound}
    Search Specific Product    ${searched_term_not_found}
    Results Search Message    ${NO_RESULTS_MESSAGE}    ${searched_term_not_found}    ${messageNotFound}
    Search Specific Product    ${searched_term_found}
    Results Search Message    ${RESULTS_MESSAGE}    ${searched_term_found}    ${message_found}

Results Search Message
    [Arguments]    ${search_message_locator}    ${search_term}    ${message}
    Wait Until Page Contains Element    ${search_message_locator}${message} ${search_term}')]

Select Specific SubCategory
    [Arguments]    ${categoryname}    ${subcategorynumber}
    Wait Until Page Contains Element    ${L_SPECIFIC_CATEGORY}${categoryname}-container']/a
    Click Element    ${L_SPECIFIC_CATEGORY}${categoryname}-container']/a
    Wait Until Page Contains Element    ${D_SPECIFIC_SUBCATEGORY}${subcategorynumber}]/a
    Click Element    ${D_SPECIFIC_SUBCATEGORY}${subcategorynumber}]/a

Open Random Product From Category Page
    Wait Until Page Contains Element    ${L_ALLSEARCH_RESULTS}
    ${allproducts} =    Get Matching Xpath Count    ${L_ALLSEARCH_RESULTS}
    ${randomsize} =    Evaluate    random.randint(1, ${allproducts})    random
    Click Element    ${L_ALLSEARCH_RESULTS}[${randomsize}]//a[@class='thumb-link']

Verify Content Tabs
    [Arguments]    ${category}    ${subcategory}
    Run Keyword If    '${category}'<>''    Select Specific SubCategory    ${category}    ${subcategory}
    Wait Until Page Contains Element    ${U_ALLCAT_TABS}
    ${all_tabs} =    Get Matching Xpath Count    ${U_ALLCAT_TABS}
    : FOR    ${index}    IN RANGE    1    ${all_tabs} + 1
    \    Run Keyword    Verify Category Tab    ${index}
    \    Run Keyword    Verify Back Category    ${index}
    Return HomePage

Verify Category Tab
    [Arguments]    ${cat_index}
    Click Element    ${U_ALLCAT_TABS}[${cat_index}]//a
    ${classTab} =    Get Element Attribute    ${U_ALLCAT_TABS}[${cat_index}]@class
    ${notReflek} =    Run Keyword And Return Status    Should Not Contain    ${classTab}    rfk
    Run Keyword If    '${notReflek}'=='True'    Verify Category Results Diplayed

Verify Back Category
    [Arguments]    ${index}
    ${previous} =    Evaluate    ${index}-1
    Run Keyword If    ${previous} >= 1    Verify Category Tab    ${previous}

Verify Category Results Diplayed
    Sleep    2
    Wait Until Page Contains Element    ${D_GRID_TILES}
    Element Should Be Visible    ${D_GRID_TILES}
    ${products_listed} =    Get Matching Xpath Count    ${D_GRID_TILES}
    Should Be True    ${products_listed} > 0

Verify View All Button
    [Arguments]    ${CLP}
    Wait Until Page Contains Element    ${D_CATEGORYLP}${CLP}']//a
    Click Element    ${D_CATEGORYLP}${CLP}']//a/img
    ${passed} =    Run Keyword And Return Status    Wait Until Page Contains Element    ${A_MORERESULTS}
    Run Keyword If    '${passed}'=='True'    Click View All Button

Click View All Button
    #${products_listed} =    Get Matching Xpath Count    ${D_GRID_TILES}
    Click Element    ${A_MORERESULTS}
    Sleep    3
    ${products_listed} =    Get Matching Xpath Count    ${D_GRID_TILES}
    Should Be True    ${products_listed}>0
    Return HomePage

Verify Infinite Scroll Shows More Products
    [Arguments]    ${category}    ${subcategory}
    Select Specific SubCategory    ${category}    ${subcategory}
    ${products_listed} =    Get Matching Xpath Count    ${D_GRID_TILES}
    Click Element    footer
    Sleep    3
    ${products_listed2} =    Get Matching Xpath Count    ${D_GRID_TILES}
    Should Be True    ${products_listed}<=${products_listed2}
    Return HomePage

Close Email Dialog If Present
    ${IS EMAIL DIALOG PRESENT}    Get Matching Xpath Count    ${LIGHTBOX}
    Run Keyword If    '${IS EMAIL DIALOG PRESENT}' != '0'    Click Close Email Dialog

Click Close Email Dialog
    Click Element    ${LIGHTBOX}
